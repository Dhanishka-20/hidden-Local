<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Vendor | Hidden Local</title>

    <!-- Main CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
</head>
<body>

<!-- ================= NAVBAR ================= -->
<nav class="navbar">
    <div class="logo-wrap">
        <img src="{{ url_for('static', filename='ui/logo.png') }}" alt="Hidden Local">
    </div>

    <ul class="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="/explore">Explore</a></li>
        <li><a href="/add-vendor-page" class="active">Add Vendor</a></li>
    </ul>
</nav>

<!-- ================= ADD VENDOR FORM ================= -->
<section class="about">
    <h2>Add a Local Vendor</h2>

    <form class="vendor-form" id="vendorForm" enctype="multipart/form-data">

        <input type="text" name="name" placeholder="Vendor Name" required>

        <select name="category" required>
            <option value="">Select Category</option>
            <option>Food</option>
            <option>Shop</option>
            <option>Service</option>
            <option>Market</option>
            <option>Handicrafts</option>
            <option>Art</option>
            <option>Fashion</option>
            <option>Home Business</option>
        </select>

        <input type="text" name="area" placeholder="City / Area" required>

        <textarea
          name="description"
          placeholder="Why is this place special?"
          rows="4"
        ></textarea>

        <label>Rating (1 to 5)</label>
        <input type="number" name="rating" min="1" max="5" required>

        <label>Select Location on Map</label>
        <div id="map" style="height:300px; border-radius:10px;"></div>
        <small style="opacity:0.7;">Click on map to drop a pin üìç</small>

        <!-- Hidden location fields -->
        <input type="hidden" name="latitude" id="latitude">
        <input type="hidden" name="longitude" id="longitude">

        <label>Upload Vendor Images</label>
        <input
          type="file"
          name="images"
          id="vendorImages"
          accept="image/*"
          multiple
          required
        >
        <small>Upload up to 5 images</small>

        <!-- Image Preview -->
        <img
          id="imagePreview"
          style="display:none; margin-top:12px; max-width:260px; border-radius:10px;"
          alt="Preview"
        >

        <button class="primary-btn" type="submit">
            Submit Vendor
        </button>
    </form>
</section>

<!-- ================= SCRIPTS ================= -->

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================= MAP ================= */
const map = L.map("map").setView([26.9124, 75.7873], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap contributors"
}).addTo(map);

let marker = null;

map.on("click", function (e) {
    if (marker) {
        marker.setLatLng(e.latlng);
    } else {
        marker = L.marker(e.latlng).addTo(map);
    }

    document.getElementById("latitude").value = e.latlng.lat;
    document.getElementById("longitude").value = e.latlng.lng;
});

/* ================= IMAGE PREVIEW ================= */
const imageInput = document.getElementById("vendorImages");
const imagePreview = document.getElementById("imagePreview");

imageInput.addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        imagePreview.src = e.target.result;
        imagePreview.style.display = "block";
    };
    reader.readAsDataURL(file);
});

/* ================= FORM SUBMIT ================= */
document.getElementById("vendorForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const lat = document.getElementById("latitude").value;
    const lng = document.getElementById("longitude").value;

    if (!lat || !lng) {
        alert("Please select location on map üìç");
        return;
    }

    const formData = new FormData(this);

    fetch("/add-vendor", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(() => {
        alert("Vendor submitted successfully ‚úÖ");
        this.reset();
        imagePreview.style.display = "none";
        if (marker) {
            map.removeLayer(marker);
            marker = null;
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error submitting vendor ‚ùå");
    });
});
</script>

</body>
</html>
