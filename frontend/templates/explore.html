<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Explore Hidden Places | Hidden Local</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<nav class="navbar">
    <h2 class="logo">Hidden Local</h2>
    <ul class="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="/explore" class="active">Explore</a></li>
        <li><a href="/add-vendor-page">Add Vendor</a></li>
    </ul>
</nav>

<main class="explore-page">

<section class="about">
    <h2 id="exploreTitle">Explore Hidden Places</h2>

    <div class="explore-filter-bar">
        <input type="text" id="searchInput" placeholder="Search by area or name">
        
        <select id="categoryFilter">
            <option value="">All Categories</option>
            <option value="Food">Food</option>
            <option value="Shop">Shop</option>
            <option value="Market">Market</option>
            <option value="Service">Service</option>
            <option value="Handicrafts">Handicrafts</option>
            <option value="Fashion">Fashion</option>
            <option value="Art">Art</option>
            <option value="Home Business">Home Business</option>
        </select>

        <button id="nearMeBtn" class="location-btn">üìç Near Me</button>
        <button id="resetBtn" class="secondary-btn">Reset</button>
    </div>

    <div id="vendorList" class="gems-grid"></div>
</section>

</main>

<script src="{{ url_for('static', filename='js/explore.js') }}"></script>
<script>
document.querySelector(".near-me-btn")?.addEventListener("click", () => {
    if (!navigator.geolocation) {
        alert("Geolocation not supported");
        return;
    }

    navigator.geolocation.getCurrentPosition(position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        fetch(`/api/hidden-gems?lat=${lat}&lng=${lng}&radius=5`)
            .then(res => res.json())
            .then(data => {
                const container = document.querySelector(".results-container");
                container.innerHTML = "";

                if (data.length === 0) {
                    container.innerHTML = "<p>No places found.</p>";
                    return;
                }

                data.forEach(v => {
                    container.innerHTML += `
                        <div class="result-card">
                            <h3>${v.name}</h3>
                            <p>${v.area} ‚Ä¢ ${v.category}</p>
                            <p>‚≠ê ${v.rating} ‚Ä¢ ${v.distance_km} km away</p>
                        </div>
                    `;
                });
            });
    });
});
</script>
<script>
document.querySelectorAll(".category-card").forEach(card => {
    card.addEventListener("click", () => {
        const category = card.dataset.category;

        fetch("/vendors")
            .then(res => res.json())
            .then(data => {
                const container = document.querySelector(".results-container");
                container.innerHTML = "";

                const filtered = data.filter(v => v.category === category);

                if (filtered.length === 0) {
                    container.innerHTML = "<p>No places found.</p>";
                    return;
                }

                filtered.forEach(v => {
                    container.innerHTML += `
                        <div class="result-card">
                            <h3>${v.name}</h3>
                            <p>${v.area}</p>
                            <p>‚≠ê ${v.rating}</p>
                        </div>
                    `;
                });
            });
    });
});
</script>
<script>
const vendorList = document.getElementById("vendorList");
const nearMeBtn = document.getElementById("nearMeBtn");
const resetBtn = document.getElementById("resetBtn");
const categoryFilter = document.getElementById("categoryFilter");
const searchInput = document.getElementById("searchInput");

/* ================= RENDER FUNCTION ================= */
function renderVendors(data) {
    vendorList.innerHTML = "";

    if (!data || data.length === 0) {
        vendorList.innerHTML = "<p>No places found.</p>";
        return;
    }

    data.forEach(v => {
        vendorList.innerHTML += `
            <div class="gem-card">
                <h3>${v.name}</h3>
                <p>${v.area} ‚Ä¢ ${v.category}</p>
                <p>‚≠ê ${v.rating}</p>
                ${v.distance_km ? `<p>üìç ${v.distance_km} km away</p>` : ""}
            </div>
        `;
    });
}

/* ================= LOAD ALL VENDORS ================= */
function loadAllVendors() {
    fetch("/vendors")
        .then(res => res.json())
        .then(renderVendors);
}

loadAllVendors();

/* ================= NEAR ME ================= */
nearMeBtn.addEventListener("click", () => {
    if (!navigator.geolocation) {
        alert("Geolocation not supported");
        return;
    }

    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        fetch(`/api/hidden-gems?lat=${lat}&lng=${lng}&radius=5`)
            .then(res => res.json())
            .then(renderVendors)
            .catch(() => {
                vendorList.innerHTML = "<p>Error fetching nearby places.</p>";
            });
    });
});

/* ================= CATEGORY FILTER ================= */
categoryFilter.addEventListener("change", () => {
    const category = categoryFilter.value;

    fetch("/vendors")
        .then(res => res.json())
        .then(data => {
            if (!category) {
                renderVendors(data);
            } else {
                renderVendors(data.filter(v => v.category === category));
            }
        });
});

/* ================= SEARCH ================= */
searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();

    fetch("/vendors")
        .then(res => res.json())
        .then(data => {
            const filtered = data.filter(v =>
                v.name.toLowerCase().includes(q) ||
                v.area.toLowerCase().includes(q)
            );
            renderVendors(filtered);
        });
});

/* ================= RESET ================= */
resetBtn.addEventListener("click", () => {
    searchInput.value = "";
    categoryFilter.value = "";
    loadAllVendors();
});
</script>

</body>
</html>