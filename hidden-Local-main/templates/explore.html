<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Explore | Hidden Local</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>

<body class="explore-page">

<!-- ================= NAVBAR ================= -->
<nav class="navbar">
    <div class="logo">Hidden Local</div>
    <ul class="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="/explore">Explore</a></li>
        <li><a href="/add-place">Add Place</a></li>
        <li>Stories</li>
    </ul>
</nav>

<!-- ================= HEADER ================= -->
<section class="explore-header">
    <h1>Explore Hidden Gems</h1>
    <p>Food, places & cultures only locals know</p>
</section>

<!-- ================= CATEGORY PANELS ================= -->
<section class="explore-categories">
    <div class="explore-card food-bg" data-filter="Food"><span>Hidden Food</span></div>
    <div class="explore-card places-bg" data-filter="Place"><span>Hidden Places</span></div>
    <div class="explore-card markets-bg" data-filter="Market"><span>Local Markets</span></div>
    <div class="explore-card culture-bg" data-filter="Culture"><span>Local Culture</span></div>
</section>

<!-- ================= LOCATION FILTER ================= -->
<div class="filter-bar">
    <select id="cityFilter">
        <option value="All">All Locations</option>
        <option value="Manali">Manali</option>
        <option value="Kasol">Kasol</option>
        <option value="Shimla">Shimla</option>
    </select>
</div>

<!-- ================= RESULTS ================= -->
<section class="explore-results" id="resultsSection" style="display:none;">
    {% for place in places %}
    <div class="result-card"
         data-category="{{ place.category }}"
         data-city="{{ place.city }}">
        <div class="card-content">
            <h3>{{ place.name }}</h3>
            <span>{{ place.city }} ‚Ä¢ {{ place.category }}</span>
            <p>{{ place.description }}</p>
        </div>
    </div>
    {% endfor %}
</section>

<!-- ================= MAP BUTTON ================= -->
<div class="map-toggle" style="display:none;" id="mapToggle">
    <button id="showMapBtn" class="big-map-btn">
        üìç Open Interactive Map
    </button>
</div>

<!-- ================= MAP (HIDDEN INITIALLY) ================= -->
<div id="map" style="display:none; height:420px; max-width:1100px; margin:40px auto 60px; border-radius:20px;"></div>

<!-- ================= SCRIPTS ================= -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ================= FILTER LOGIC ================= */
const cards = document.querySelectorAll(".result-card");
const filters = document.querySelectorAll(".explore-card");
const resultsSection = document.getElementById("resultsSection");
const cityFilter = document.getElementById("cityFilter");
const mapToggle = document.getElementById("mapToggle");

filters.forEach(filter => {
    filter.addEventListener("click", () => {
        const selectedCategory = filter.dataset.filter;

        resultsSection.style.display = "block";
        mapToggle.style.display = "block";

        cards.forEach(card => {
            const matchCategory =
                card.dataset.category.toLowerCase().trim() ===
                selectedCategory.toLowerCase().trim();

            const matchCity =
                cityFilter.value === "All" ||
                card.dataset.city === cityFilter.value;

            card.style.display = (matchCategory && matchCity) ? "block" : "none";
        });
    });
});

cityFilter.addEventListener("change", () => {
    resultsSection.style.display = "block";
    mapToggle.style.display = "block";

    cards.forEach(card => {
        const matchCity =
            cityFilter.value === "All" ||
            card.dataset.city === cityFilter.value;

        card.style.display = matchCity ? "block" : "none";
    });
});

/* ================= MAP (INITIALIZE ON BUTTON CLICK) ================= */
let map;
let mapInitialized = false;
let selectedMarker = null;

const showMapBtn = document.getElementById("showMapBtn");
const mapDiv = document.getElementById("map");

showMapBtn.addEventListener("click", () => {
    mapDiv.style.display = "block";

    if (!mapInitialized) {
        map = L.map('map').setView([32.2396, 77.1887], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        const placesData = {{ places | tojson }};

        placesData.forEach(place => {
            if (place.lat && place.lng) {
                L.marker([place.lat, place.lng])
                    .addTo(map)
                    .bindPopup(`<b>${place.name}</b><br>${place.city}`);
            }
        });

        // Google Maps style click selection
        map.on('click', function(e) {
            if (selectedMarker) {
                map.removeLayer(selectedMarker);
            }

            selectedMarker = L.marker(e.latlng)
                .addTo(map)
                .bindPopup(
                    `Selected Location<br>
                     Lat: ${e.latlng.lat.toFixed(6)}<br>
                     Lng: ${e.latlng.lng.toFixed(6)}`
                )
                .openPopup();
        });

        mapInitialized = true;
    }

    setTimeout(() => {
        map.invalidateSize();
    }, 200);

    mapDiv.scrollIntoView({ behavior: "smooth" });
});
</script>

</body>
</html>
